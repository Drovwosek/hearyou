# üé≠ Speaker Diarization - –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

## –°—Ç–∞—Ç—É—Å

**–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:** 2026-02-27  
**–ü—Ä–∏—á–∏–Ω–∞:** –¢—Ä–µ–±—É–µ—Ç—Å—è HuggingFace —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ gated –º–æ–¥–µ–ª–∏ pyannote

---

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **torch 2.0.1** (CPU version) - —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
2. **torchaudio 2.0.2** - —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ  
3. **pyannote.audio 3.0.1** - —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ
4. **numpy 1.24.3** - —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è –≤–µ—Ä—Å–∏—è ‚úÖ
5. **huggingface_hub 0.19.4** - downgrade –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ‚úÖ

### ‚úÖ –ù–∞–ø–∏—Å–∞–Ω –∫–æ–¥:

1. **`speaker_diarization.py`** - –º–æ–¥—É–ª—å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏
   - –ö–ª–∞—Å—Å `SpeakerDiarization`
   - –§—É–Ω–∫—Ü–∏—è `merge_transcription_with_speakers()`
   - –§—É–Ω–∫—Ü–∏—è `format_with_speakers()`

2. **`app.py`** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–æ—Ç–∫–∞—á–µ–Ω–∞)
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ Yandex + pyannote
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ timestamps
   - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

3. **`static/index.html`** - UI (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω)
   - Checkbox "üé≠ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–∏–∫–µ—Ä–æ–≤"
   - –°—Ç–∏–ª–∏ –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - JavaScript –æ–±—Ä–∞–±–æ—Ç–∫–∞

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

- `SPEAKER_DIARIZATION_IMPLEMENTATION.md` - –ø–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- `API_V3_MIGRATION_PLAN.md` - –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Yandex v3
- `SPEAKER_LABELING_RESEARCH.md` - –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ Yandex API v2

---

## –ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–¥–µ–ª—å `pyannote/speaker-diarization-3.0` - **GATED**

–¢—Ä–µ–±—É–µ—Ç—Å—è:
1. HuggingFace –∞–∫–∫–∞—É–Ω—Ç
2. Access token (read)
3. Accept —É—Å–ª–æ–≤–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–∏

–ë–µ–∑ —Ç–æ–∫–µ–Ω–∞ `Pipeline.from_pretrained()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`, –∏ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

---

## –ö–∞–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–º

### –í–∞—Ä–∏–∞–Ω—Ç 1: HuggingFace —Ç–æ–∫–µ–Ω (5 –º–∏–Ω—É—Ç)

**–®–∞–≥ 1:** –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
```
1. https://huggingface.co/join - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
2. https://huggingface.co/settings/tokens - —Å–æ–∑–¥–∞—Ç—å Read —Ç–æ–∫–µ–Ω
3. https://huggingface.co/pyannote/speaker-diarization-3.0 - Accept —É—Å–ª–æ–≤–∏—è
```

**–®–∞–≥ 2:** –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
```bash
# –í .env —Ñ–∞–π–ª
echo "HUGGINGFACE_TOKEN=hf_xxxxxxxxxxxxx" >> /root/hearyou/.env.yandex

# –í docker-compose.yml (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
environment:
  - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
```

**–®–∞–≥ 3:** –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
```bash
# –í app.py - —É–±—Ä–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏
# –í static/index.html - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å checkbox
```

**–®–∞–≥ 4:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
```bash
docker restart hearyou-stt
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—è

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- –ü–∞—É–∑ –≤ –∞—É–¥–∏–æ (–¥–µ—Ç–µ–∫—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≥–æ–ª–æ—Å–∞)
- –†–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–æ—Ç (pitch detection)
- –ë–µ–∑ ML –º–æ–¥–µ–ª–∏

**–ü–ª—é—Å—ã:** –ù–µ –Ω—É–∂–µ–Ω —Ç–æ–∫–µ–Ω, –±—ã—Å—Ç—Ä–æ  
**–ú–∏–Ω—É—Å—ã:** –¢–æ—á–Ω–æ—Å—Ç—å –Ω–∏–∂–µ (~60-70% vs 85-92% —É pyannote)

---

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∫–æ–¥–∞

### –ê–∫—Ç–∏–≤–Ω–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç):
- ‚úÖ Yandex STT (–æ–±—ã—á–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è)
- ‚úÖ Hints –¥–ª—è —Ç–µ—Ä–º–∏–Ω–æ–≤ (40+ —Å–ª–æ–≤)
- ‚úÖ Corrections (32 –ø—Ä–∞–≤–∏–ª–∞)
- ‚úÖ –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤-–ø–∞—Ä–∞–∑–∏—Ç–æ–≤
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤ (–¥–æ 25GB)

### –û—Ç–∫–ª—é—á–µ–Ω–æ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ):
- ‚è∏Ô∏è Speaker diarization checkbox –≤ UI
- ‚è∏Ô∏è –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ pyannote
- ‚è∏Ô∏è –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –ì–æ—Ç–æ–≤–æ –∫ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:
- üì¶ –ú–æ–¥—É–ª—å `speaker_diarization.py` (–≥–æ—Ç–æ–≤)
- üì¶ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- üì¶ –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω
- üì¶ –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ HF —Ç–æ–∫–µ–Ω

---

## –§–∞–π–ª—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–ë—ç–∫–∞–ø—ã:**
```
/root/hearyou/packages/stt-service/app.py.with_diarization
/root/hearyou/packages/stt-service/speaker_diarization.py
```

**–í–µ—Ä—Å–∏—è —Å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–µ–π (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è):**
```html
<!-- –í static/index.html —Å—Ç—Ä–æ–∫–∏ 161-166 -->
<div class="options-section">
    <label>
        <input type="checkbox" id="speakerLabeling" name="speaker_labeling">
        üé≠ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–∏–∫–µ—Ä–æ–≤ (–∫—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç)
    </label>
</div>
```

---

## –û—Ü–µ–Ω–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

**–ï—Å–ª–∏ –µ—Å—Ç—å HF —Ç–æ–∫–µ–Ω:**
- ‚è±Ô∏è –í—Ä–µ–º—è: 5-10 –º–∏–Ω—É—Ç
- üîß –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥)
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: 95%

**–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
- ‚è±Ô∏è –í—Ä–µ–º—è: 2-3 —á–∞—Å–∞
- üîß –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è (–Ω–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º)
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å: 30%

---

## –í—ã–≤–æ–¥—ã

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:
‚úÖ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (Yandex —Ç–µ–∫—Å—Ç + pyannote —Å–ø–∏–∫–µ—Ä—ã)  
‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–ø–æ—á—Ç–∏ –±–µ–∑ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è)  
‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞  
‚úÖ –ö–æ–¥ –Ω–∞–ø–∏—Å–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω (—á–∞—Å—Ç–∏—á–Ω–æ)

### –ß—Ç–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ:
‚ùå Gated –º–æ–¥–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω  
‚ùå –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏/–∂–µ–ª–∞–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–µ–π—á–∞—Å

### –ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Ç–æ–º:
1. –ü–æ–ª—É—á–∏—Ç—å HF —Ç–æ–∫–µ–Ω (5 –º–∏–Ω) ‚Üí –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Yandex v3 (–µ—Å–ª–∏ –¥–æ–±–∞–≤—è—Ç support)
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –¥–∏–∞—Ä–∏–∑–∞—Ü–∏—é –±–µ–∑ ML
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π STT —Å –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–µ–π (AssemblyAI, Whisper API)

---

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ.

**–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ –±–µ–∑ –¥–∏–∞—Ä–∏–∑–∞—Ü–∏–∏.
